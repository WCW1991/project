#include "Common.h"
/*
*********************************************************************************************************
*
* 文件名    : Common.c
* 版本号    : V1.00
* 作  者    : j
*             
*
* 版权说明  : 成都安吉斯智能设备有限公司
* 文件描述  : 通用函数
* 开发环境  : 
* 修改日期  : 2017/03/21
*********************************************************************************************************
*/

/*******************************************************************************
* 函数名         : delay_us
* 功能描述       : 微秒延时，使用普通定时器TIM6
*                  
* 输入参数       : N	延时时间 单位 us

* 返回值         : 无
*******************************************************************************/
void delay_us( uint16_t N )
{
	TIM6->CNT = 0;
	TIM6->CR1 |= (1<<0);
	while(TIM6->CNT < N);
	return;
}

/*******************************************************************************
* 函数名         : CRC8_Calculate
* 功能描述       : 根据查表计算CRC校验
*                  
* 输入参数       : -pdata	待计算的数据指针

* 返回值         : 返回CRC校验，为1个uint8_t类型的数据	
*******************************************************************************/
uint8_t	const CRC_Table[256]={
	0x00,0x5e,0xbc,0xe2,0x61,0x3f,0xdd,0x83,
	0xc2,0x9c,0x7e,0x20,0xa3,0xfd,0x1f,0x41,
	0x9d,0xc3,0x21,0x7f,0xfc,0xa2,0x40,0x1e,
	0x5f,0x01,0xe3,0xbd,0x3e,0x60,0x82,0xdc,
	0x23,0x7d,0x9f,0xc1,0x42,0x1c,0xfe,0xa0,
	0xe1,0xbf,0x5d,0x03,0x80,0xde,0x3c,0x62,
	0xbe,0xe0,0x02,0x5c,0xdf,0x81,0x63,0x3d,
	0x7c,0x22,0xc0,0x9e,0x1d,0x43,0xa1,0xff,
	0x46,0x18,0xfa,0xa4,0x27,0x79,0x9b,0xc5,
	0x84,0xda,0x38,0x66,0xe5,0xbb,0x59,0x07,
	0xdb,0x85,0x67,0x39,0xba,0xe4,0x06,0x58,
	0x19,0x47,0xa5,0xfb,0x78,0x26,0xc4,0x9a,
	0x65,0x3b,0xd9,0x87,0x04,0x5a,0xb8,0xe6,
	0xa7,0xf9,0x1b,0x45,0xc6,0x98,0x7a,0x24,
	0xf8,0xa6,0x44,0x1a,0x99,0xc7,0x25,0x7b,
	0x3a,0x64,0x86,0xd8,0x5b,0x05,0xe7,0xb9,
	0x8c,0xd2,0x30,0x6e,0xed,0xb3,0x51,0x0f,
	0x4e,0x10,0xf2,0xac,0x2f,0x71,0x93,0xcd,
	0x11,0x4f,0xad,0xf3,0x70,0x2e,0xcc,0x92,
	0xd3,0x8d,0x6f,0x31,0xb2,0xec,0x0e,0x50,
	0xaf,0xf1,0x13,0x4d,0xce,0x90,0x72,0x2c,
	0x6d,0x33,0xd1,0x8f,0x0c,0x52,0xb0,0xee,
	0x32,0x6c,0x8e,0xd0,0x53,0x0d,0xef,0xb1,
	0xf0,0xae,0x4c,0x12,0x91,0xcf,0x2d,0x73,
	0xca,0x94,0x76,0x28,0xab,0xf5,0x17,0x49,
	0x08,0x56,0xb4,0xea,0x69,0x37,0xd5,0x8b,
	0x57,0x09,0xeb,0xb5,0x36,0x68,0x8a,0xd4,
	0x95,0xcb,0x29,0x77,0xf4,0xaa,0x48,0x16,
	0xe9,0xb7,0x55,0x0b,0x88,0xd6,0x34,0x6a,
	0x2b,0x75,0x97,0xc9,0x4a,0x14,0xf6,0xa8,
	0x74,0x2a,0xc8,0x96,0x15,0x4b,0xa9,0xf7,
	0xb6,0xe8,0x0a,0x54,0xd7,0x89,0x6b,0x35,
};
uint8_t	CRC8_Calculate(uint8_t	*pdata,uint32_t len)
{
	uint8_t	CRC8=0;
	
	while(len--)
	{
		CRC8=CRC_Table[CRC8^*pdata];
		pdata++;
	}

	return CRC8;
}

/*******************************************************************************
* 函数名         : crc_16
* 功能描述       : 根据查表计算CRC16校验
*                  
* 输入参数       : -q	待计算的数据指针

* 返回值         : 返回CRC校验，为1个uint16_t类型的数据	
*******************************************************************************/
uint16_t const ccitt_table[256] = {
	0, 0xc1c0, 0x81c1, 0x4001, 0x1c3, 0xc003, 0x8002, 0x41c2, 0x1c6, 0xc006, 0x8007, 0x41c7, 5, 0xc1c5, 0x81c4, 0x4004,
	460, 0xc00c, 0x800d, 0x41cd, 15, 0xc1cf, 0x81ce, 0x400e, 10, 0xc1ca, 0x81cb, 0x400b, 0x1c9, 0xc009, 0x8008, 0x41c8,
	0x1d8, 0xc018, 0x8019, 0x41d9, 0x1b, 0xc1db, 0x81da, 0x401a, 30, 0xc1de, 0x81df, 0x401f, 0x1dd, 0xc01d, 0x801c, 0x41dc,
	20, 0xc1d4, 0x81d5, 0x4015, 0x1d7, 0xc017, 0x8016, 0x41d6, 0x1d2, 0xc012, 0x8013, 0x41d3, 0x11, 0xc1d1, 0x81d0, 0x4010,
	0x1f0, 0xc030, 0x8031, 0x41f1, 0x33, 0xc1f3, 0x81f2, 0x4032, 0x36, 0xc1f6, 0x81f7, 0x4037, 0x1f5, 0xc035, 0x8034, 0x41f4,
	60, 0xc1fc, 0x81fd, 0x403d, 0x1ff, 0xc03f, 0x803e, 0x41fe, 0x1fa, 0xc03a, 0x803b, 0x41fb, 0x39, 0xc1f9, 0x81f8, 0x4038,
	40, 0xc1e8, 0x81e9, 0x4029, 0x1eb, 0xc02b, 0x802a, 0x41ea, 0x1ee, 0xc02e, 0x802f, 0x41ef, 0x2d, 0xc1ed, 0x81ec, 0x402c,
	0x1e4, 0xc024, 0x8025, 0x41e5, 0x27, 0xc1e7, 0x81e6, 0x4026, 0x22, 0xc1e2, 0x81e3, 0x4023, 0x1e1, 0xc021, 0x8020, 0x41e0,
	0x1a0, 0xc060, 0x8061, 0x41a1, 0x63, 0xc1a3, 0x81a2, 0x4062, 0x66, 0xc1a6, 0x81a7, 0x4067, 0x1a5, 0xc065, 0x8064, 0x41a4,
	0x6c, 0xc1ac, 0x81ad, 0x406d, 0x1af, 0xc06f, 0x806e, 0x41ae, 0x1aa, 0xc06a, 0x806b, 0x41ab, 0x69, 0xc1a9, 0x81a8, 0x4068,
	120, 0xc1b8, 0x81b9, 0x4079, 0x1bb, 0xc07b, 0x807a, 0x41ba, 0x1be, 0xc07e, 0x807f, 0x41bf, 0x7d, 0xc1bd, 0x81bc, 0x407c,
	0x1b4, 0xc074, 0x8075, 0x41b5, 0x77, 0xc1b7, 0x81b6, 0x4076, 0x72, 0xc1b2, 0x81b3, 0x4073, 0x1b1, 0xc071, 0x8070, 0x41b0,
	80, 0xc190, 0x8191, 0x4051, 0x193, 0xc053, 0x8052, 0x4192, 0x196, 0xc056, 0x8057, 0x4197, 0x55, 0xc195, 0x8194, 0x4054,
	0x19c, 0xc05c, 0x805d, 0x419d, 0x5f, 0xc19f, 0x819e, 0x405e, 90, 0xc19a, 0x819b, 0x405b, 0x199, 0xc059, 0x8058, 0x4198,
	0x188, 0xc048, 0x8049, 0x4189, 0x4b, 0xc18b, 0x818a, 0x404a, 0x4e, 0xc18e, 0x818f, 0x404f, 0x18d, 0xc04d, 0x804c, 0x418c,
	0x44, 0xc184, 0x8185, 0x4045, 0x187, 0xc047, 0x8046, 0x4186, 0x182, 0xc042, 0x8043, 0x4183, 0x41, 0xc181, 0x8180, 0x4040
};

uint16_t crc_16(uint8_t *q, uint16_t len)
{
	uint16_t crc = 0xffff;

	while (len-- > 0)
	crc = ccitt_table[(crc >> 8 ^ *q++) & 0xff] ^ (crc << 8);
	
	return ((crc>>8)|(crc<<8));
}
